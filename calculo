import re
import streamlit as st
from streamlit.components.v1 import html

# --- Fun√ß√µes ---
def calcular_preco_projeto(tempo_horas, filamento_gramas):
    custo_impressora_hora = 2.45
    custo_filamento_grama = 100 / 1000
    custo_energia_hora = 0.12

    custo_impressora = tempo_horas * custo_impressora_hora
    custo_filamento = filamento_gramas * custo_filamento_grama
    custo_energia = tempo_horas * custo_energia_hora
    custo_total = custo_impressora + custo_filamento + custo_energia
    preco_final = custo_total * 1.5  # 50% lucro

    return {
        "Custo Impressora": round(custo_impressora, 2),
        "Custo Filamento": round(custo_filamento, 2),
        "Custo Energia": round(custo_energia, 2),
        "Custo Total": round(custo_total, 2),
        "Pre√ßo Final": round(preco_final, 2)
    }

def converter_tempo_para_horas(entrada: str) -> float:
    entrada = entrada.lower().strip()
    horas = re.search(r"(\d+(?:\.\d+)?)\s*h", entrada)
    minutos = re.search(r"(\d+(?:\.\d+)?)\s*min", entrada)

    total_horas = 0.0
    if horas:
        total_horas += float(horas.group(1))
    if minutos:
        total_horas += float(minutos.group(1)) / 60
    if not horas and not minutos:
        total_horas = float(entrada)
    return total_horas

# --- Interface Streamlit ---
st.title("üí° Calculadora de Pre√ßo - Impress√£o 3D")

tempo_input = st.text_input("Digite o tempo de impress√£o (ex: 2h, 30min, 1h 20min)")
filamento = st.number_input("Digite a quantidade de filamento (gramas)", min_value=0.0)

if st.button("Calcular"):
    try:
        tempo = converter_tempo_para_horas(tempo_input)
        resultado = calcular_preco_projeto(tempo, filamento)

        # Criar tabela HTML com destaque no pre√ßo final
        tabela_html = "<table style='border-collapse: collapse;'>"
        tabela_html += "<tr><th style='border:1px solid #ccc;padding:8px;text-align:left;'>Descri√ß√£o</th>"
        tabela_html += "<th style='border:1px solid #ccc;padding:8px;text-align:right;'>Valor (R$)</th></tr>"

        for item, valor in resultado.items():
            if "Pre√ßo Final" in item:
                tabela_html += f"<tr><td style='border:1px solid #ccc;padding:8px;font-weight:bold;color:green'>{item}</td>"
                tabela_html += f"<td style='border:1px solid #ccc;padding:8px;text-align:right;font-weight:bold;color:green'>{valor:.2f}</td></tr>"
            else:
                tabela_html += f"<tr><td style='border:1px solid #ccc;padding:8px;font-weight:bold;color:#00bcd4'>{item}</td>"
                tabela_html += f"<td style='border:1px solid #ccc;padding:8px;text-align:right;color:#00bcd4'>{valor:.2f}</td></tr>"

        tabela_html += "</table>"

        st.markdown("### Resultado:")
        html(tabela_html, height=300)

    except:
        st.error("Erro: verifique o formato do tempo digitado.")
